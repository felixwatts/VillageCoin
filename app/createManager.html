<!DOCTYPE html>
<html>
<head>
  <title>VillageCoin - Propose Appointment of a New Gatekeeper</title>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <script src="./common.js"></script>
</head>
<body>
    <h1>VillageCoin</h1>
    <h2>Propose Appointment of a New Gatekeeper</h2>
    <ul class="menu">
        <li><a href="index.html">Home</a></li>
        <li><a href="proposals.html">Vote</a></li>
        <li><a href="createProposal.html">Make a Proposal</a></li>
    </ul>
    <br>
        <br><label for="gatekeeperAddress">New Gatekeeper's Address:</label>
        <input type="text" id="gatekeeperAddress" placeholder="e.g., 0x93e66d9baea28c17d9fc393b53e3fbdd76899dae" onchange="validateForm()"></input>    
        <br><br><button id="btnSend" onclick="submit()" disabled>Create Proposal</button><span id="formInvalidMessage"></span>
        <br><br>    
    <br>
    <div id="status"></div>
</body>
</html>
<script>

    async function validateForm() {

        try
        {
            var isValid = true;
            var invalidReason = "";

            var toAddress = document.getElementById("gatekeeperAddress").value;
            
            if(toAddress == undefined)
            {
                isValid = false;
                invalidReason = "You must enter the address of the new gatekeeper";
            }
            else
            {
                var isValidAddress = web3.isAddress(toAddress);
                if(!isValidAddress)
                {
                    isValid = false;
                    invalidReason = "The gatekeeper address is not a valid Ethereum address";
                }
                else
                {
                    var villageCoin = app.contract;
                    var isCitizen = await villageCoin.isCitizen.call(toAddress, {from: app.account});

                    if(!isCitizen)
                    {
                        isValid = false;
                        invalidReason = "The gatekeeper must be a citizen";
                    }
                    else
                    {
                        var isGatekeeper = await villageCoin.isGatekeeper.call(toAddress, {from: app.account});
                        if(isGatekeeper)
                        {
                            isValid = false;
                            invalidReason = "The specified address is already a gatekeeper";
                        }
                    }
                }
            }

            var sendButton = document.getElementById("btnSend");
            sendButton.disabled = !isValid;
            var sendInvalidMessage = document.getElementById("formInvalidMessage");
            sendInvalidMessage.innerHTML = invalidReason;
        }
        catch(error)
        {
            app.setStatus(error);
        }
    }

async function submit() 
{
    try 
    {
        app.setStatus("Initiating transaction... (please wait)");

        var gatekeeperAddress = document.getElementById("gatekeeperAddress").value;
        
        var villageCoin = app.contract;
        var receipt = await villageCoin.proposeAppointGatekeeper(gatekeeperAddress, {from: app.account});

        var proposalId = receipt.logs[0].args.proposalId.toNumber();
        window.location.replace("proposal.html?id=" + proposalId);
    } 
    catch(error) 
    {
        app.setStatus(error);
    }
}

window.addEventListener('load', async function()
{
    await init();
    await app.initVillage();
    app.redirectNonCitizen();
});

</script>