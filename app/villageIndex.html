<!DOCTYPE html>
<html>
<head>
  <title>VillageCoin - Home</title>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <script src="./common.js"></script>
</head>
<body>
    <h1>VillageCoin</h1>
    <h2>Home</h2>
    <ul class="menu">
        <li><a href="index.html">Home</a></li>
        <li><a href="proposals.html">Vote</a></li>
        <li><a href="createProposal.html">Make a Proposal</a></li>
    </ul>

    <h3>VillageCoin Balance: <strong id="balance"></strong></h3>

    <h3>Send VillageCoin</h3>    
    <br><label for="amount">Amount:</label><input type="text" id="amount" placeholder="e.g., 5" onchange="validateSendForm()"></input>  
    <br><label for="toAddress">To Account:</label><input type="text" id="toAddress" placeholder="e.g., 0x93e66d9baea28c17d9fc393b53e3fbdd76899dae" onchange="validateSendForm()"></input>    
    <br><br><button id="btnSend" onclick="send()" disabled>Send</button><span id="formInvalidMessage"></span>
    <br>
    <span id="status"></span>    
</body>
</html>
<script>

    async function validateSendForm() {

        try
        {
            var isValid = true;
            var invalidReason = "";

            var amount = parseInt(document.getElementById("amount").value);
            if(isNaN(amount) || amount < 0)
            {
                isValid = false;
                invalidReason = "The amount must be a positive integer";
            }
            else
            {
                var toAddress = document.getElementById("toAddress").value;
                var isValidAddress = web3.isAddress(toAddress);
                if(isValidAddress)
                {
                    var villageCoin = app.contract;                
                    var isCitizen = await villageCoin.isCitizen.call(toAddress, amount, {from: app.account});
                    if(!isCitizen)
                    {
                        isValid = false;
                        invalidReason = "The 'To Account' is not a VillageCoin citizen";
                    }
                }
                else
                {
                    isValid = false;
                    invalidReason = "The 'To Account' is not a valid Ethereum address";
                }
            }

            var sendButton = document.getElementById("btnSend");
            sendButton.disabled = !isValid;
            var sendInvalidMessage = document.getElementById("formInvalidMessage");
            sendInvalidMessage.innerHTML = invalidReason;
        }
        catch(error)
        {
            console.log(error);
            app.setStatus(error);
        }
    }

    async function populateBalance() 
    {
        try
        {
            var villageCoin = app.contract;
            var decimals = await villageCoin.decimals.call({from: app.account});
            var symbol = await villageCoin.symbol.call({from: app.account});
            var balance = await villageCoin.balanceOf.call(app.account, {from: app.account});
            document.getElementById("balance").innerHTML = balance.toFormat(decimals.toNumber()) + " " + symbol;
        }
        catch(error)
        {
            console.log(error);
            app.setStatus(error);
        }
    }    

    async function send()
    {
        try
        {
            app.setStatus("Sending VillageCoin...");

            var villageCoin = app.contract;
            var amount = parseInt(document.getElementById("amount").value);
            var toAddress = document.getElementById("toAddress").value;

            await villageCoin.transfer(toAddress, amount, {from: app.account});

            populateBalance();
            app.setStatus("Sending succeeded");
        }
        catch(error)
        {
            console.log(error);
            app.setStatus(error);
        }
    }

    window.addEventListener('load', async function()
    { 
        await init();
        await app.initVillage();
        app.redirectNonCitizen(); 
        await populateBalance();
    });
</script>
