<!DOCTYPE html>
<html>
<head>
  <title>VillageCoin - Vote</title>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <script src="./common.js"></script>
</head>
<body>
    <h1>VillageCoin</h1>
    <ul class="menu">
        <li><a href="index.html">Home</a></li>
        <li><a href="proposals.html">Vote</a></li>
        <li><a href="createProposal.html">Make a Proposal</a></li>
    </ul>

    <h2>Open Proposals</h2>  
    <p class="hint">This is a list of proposals that are awaiting your vote. Although you never <em>have</em> to vote, it's important if you want to influence the future of the currency</p>    
    <table id="tableProposals"></table>

    <div id="status"></div>    
</body>
</html>
<script lang="javascript">

function filterProposalByVotable(proposal) 
{
    var isExistent = proposal[1];
    return isExistent;
}

async function buildProposalRow(proposal)
{
    var proposalId = proposal[0].toNumber();
    var description = await app.getProposalDescription(proposalId);
    return "<tr><td><a href='proposal.html?id=" + proposalId + "'>proposal #" + proposalId + "</a></td><td>" + description + "</a>";
}

async function populateProposalsTable() 
{
    try 
    {
        var villageCoin = app.contract;
        var maxProposalId = await villageCoin.getMaxProposalId.call({from: app.account});
        var allProposalIds = [...Array(maxProposalId.toNumber()).keys()];
        var allProposalsBasicDetails = await Promise.all(allProposalIds.map(function(id){ return villageCoin.getProposalBasicDetails.call(id, {from: app.account}) }));

        var votableProposalsBasicDetails = allProposalsBasicDetails
            .filter(filterProposalByVotable);
        var votableProposals = await Promise.all(votableProposalsBasicDetails
            .map(buildProposalRow));

        var proposalsTableHtml = votableProposals.length == 0 
            ? "There are no outstanding proposals" 
            : votableProposals
                .reduce(function(accumulator, currentValue) { return accumulator + currentValue; }, "");

        document.getElementById("tableProposals").innerHTML = proposalsTableHtml;
    } 
    catch(error)
    {
        console.log(error);
        app.setStatus(error);
    }
}

window.addEventListener('load', async function()
{
    await init();
    await app.initVillage();
    app.redirectNonUser();
    await populateProposalsTable();
});
</script>
