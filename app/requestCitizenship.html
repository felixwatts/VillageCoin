<!DOCTYPE html>
<html>
<head>
    <title>VillageCoin - Claim Your Account</title>
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <script src="./common.js"></script>
</head>
<body>
    <h1 class="villageName"></h1>
    <h2>Claim Your Account</h2>    

    <p>The <span class="villageName" ></span> economy has some requirements for entry. In order to prove that you meet those requirements you need to provide some evidence.</p>
    <p>The items you provide here will only be visible to members of the <span class="villageName" ></span> GateKeeper Committee, and are only used to verify that you are eligible for an account. </p>
    <p>Once your account is created it is not traceable to your identity.</p>
    <p>After you submit your application it will be assessed by the <span class="villageName" ></span> GateKeeper Committee, which can take several days, after which your account will be available.</p>
    <p>For a detailed description of how the gatekeeping process works <a href="accountVerificationProcess.html">see here</a> or take a look at the <a href="https://github.com/felixwatts/VillageCoin">source code</a></p>

    <h3>1. Ethereum Address</h3>
    <p>Choose which Ethereum account/address will be associated with your <span class="villageName" ></span> account.
        <ul>
            <li>To maximize anonymity you should generate a new address for this</li>
            <li>Once your account is created you cannot change which Ethereum account it is linked to</li>
        </ul>
    </p>
    <select id="ethereumAddress" onchange="populateProofOfIntentionText()"></select>

    <h3>2. Supporting Evidence</h3>
    <p>Provide a file containing evidence that you are eligible to become a citizen of <span class="villageName" ></span>. The <span class="villageName" ></span> community has provided <a id="supportingEvidenceGuideUrl" href="todo.html">this guide</a> to help you prepare the necessary file</p>
    <input type="file" id="supportingEvidence"/>

    <button onclick="submit()">Submit</button>
    <div id="status"></div>
  
</body>
</html>
<script lang="javascript">

function tryReadSelectedFileAsBinaryString(inputElementId, inputDescription)
{
    var promise = new Promise(function(resolve, reject) 
    {
        try 
        {
            var files = document.getElementById(inputElementId).files;
            if(files.length != 1) reject("You must select a " + inputDescription);
            var file = files[0];
            if (!file.type.match('image.*')) reject("Invalid " + inputDescription);
            var reader = new FileReader();
            reader.onload = function(e) { resolve(reader.result); }
            reader.onerror = function(e) { reject(e); }
            reader.readAsBinaryString(file);
        } 
        catch(error)
        {
            reject(error);
        }
    });

    return promise;
}

async function submit() {

    try 
    {
        app.setStatus("Initiating transaction... (please wait)");

        var dropDown = document.getElementById("ethereumAddress");
        var selectedAccount = dropDown.options[dropDown.selectedIndex].value;
        if(selectedAccount == undefined) throw("You must select an ethereum account");
        
        var supportingEvidence = await tryReadSelectedFileAsBinaryString("supportingEvidence", "supporting evidence");


        // TODO when swarm is properly available
        // // get addresses of all managers

        // // encrypt proof of identity file for each manager
        
        // // encrypt proof of intention file for each manager

        // // upload the files to swarm

        // var bzz = web3.bzz;

        // var dir = {
        //      "/proofOfIdentity": {type: "application/octet-stream", data: proofOfIdentityData},
        //      "/proofOfIntention": {type: "application/octet-stream", data: proofOfIntentionData}
        // };
        // var supportingEvidenceSwarmHash = await bzz.upload(dir);

        // // execute the createAccount transaction with the URI of the supporting evidence
        
        var villageCoin = app.contract;
        var receipt = await villageCoin.proposeAddCitizen(selectedAccount, "supporting evidence" /* TODO */, {from: selectedAccount});
        var proposalId = receipt.logs[0].args.proposalId.toNumber();

        window.location.replace("proposal.html?contractAddress=" + villageCoin.address + "&id=" + proposalId);

    } 
    catch(error) 
    {
        app.setStatus(error);
    }
}

function populateAccountsDropDown() {

    web3.eth.getAccounts(function(err, accs) {
        if (err != null) {
            return;
        }

        var html = accs
            .map(function(account){ return "<option value='" + account + "'>" + account + "</option>";})
            .reduce(function(accumulator, currentValue) { return accumulator + currentValue; }, "");
        document.getElementById("ethereumAddress").innerHTML = html;
    });    
}

window.addEventListener('load', async function() { 
    await init();
    await app.initVillage();
    app.redirectCitizen();
    await app.populateVillageName();
    populateAccountsDropDown();    
});

</script>
