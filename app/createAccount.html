<!DOCTYPE html>
<html>
<head>
    <title>VillageCoin - Index</title>
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <script src="./common.js"></script>
</head>
<body>
    <h1>VillageCoin</h1>
    <h2>Claim Your Account</h2>    

    <p>Every person who has a government issued ID or Passport is entitled to one VillageCoin account. In order for us to determine that you are a real person and that you don't already have an account, you need to provide some documents.</p>
    <p>The items you provide here will only be visible to members of the management committee, and are only used to verify that you are eligable for an account. </p>
    <p>Once your account is created it is not tracable to your identity.</p>
    <p>After you submit your application it will be assessed by the management committee, which can take several days, after which your account will be available.</p>
    <p>To complete the application you will need..
        <ul>
            <li>Your government issued ID or Passport, or a photo of it</li>
            <li>A digital camera</li>
            <li>A pen and a piece of paper</li>
        </ul>
    </p>

    <h3>1. Ethereum Address</h3>
    <p>Choose which Ethereum account/address will be associated with your VillageCoin account.
        <ul>
            <li>To maximise annonymity you should generate a new address for this</li>
            <li>Once your account is created you cannot change which Ethereum account it is linked to</li>
        </ul>
    </p>
    <select id="ethereumAddress" onchange="populateProofOfIntentionText()"></select>


    <h3>2. Proof of Identity</h3>
    <p>Provide a photo of your government issued ID or Passport
        <ul>
            <li>Make sure the image of your face is clearly visible</li>
            <li>Make sure the ID number or Passport number is clearly legible</li>
        </ul>
    </p>
    <input type="file" id="proofOfIdentity"/>

    <h3>3. Proof of Intention</h3>
    <p>Provide a photo of yourself holding a piece of paper that has the following text written on it:
        <strong id="proofOfIntentionText"></strong>
        <ul>
            <li>Make sure your face is clearly visible</li>
            <li>Make sure the text is clearly legible</li>
        </ul>        
    </p>
    <input type="file" id="proofOfIntention"/>

    <button onclick="submit()">Submit</button>
    <span id="status"></span>
  
</body>
</html>
<script lang="javascript">

function tryReadSelectedFileAsBinaryString(inputElementId, inputDescription)
{
    var files = document.getElementById(inputElementId).files;
    if(files.length != 1) throw("You must select a " + inputDescription);
    var file = files[0];
    if (!file.type.match('image.*')) throw("Invalid " + inputDescription);
    var reader = new FileReader();
    var binaryString = reader.readAsBinaryString(file);
    return binaryString; // this doesnt work - need to handle events and promisify and async/await
}

async function submit() {

    try 
    {
        app.setStatus("Initiating transaction... (please wait)");

        var dropDown = document.getElementById("ethereumAddress");
        var selectedAccount = dropDown.options[dropDown.selectedIndex].value;
        if(selectedAccount == undefined) throw("You must select an ethereum account");
        
        // get proof of identity file data
        var proofOfIdentityData = tryReadSelectedFileAsBinaryString("proofOfIdentity", "proof of identity image");

        // get proof of intention file data
        var proofOfIntentionData = tryReadSelectedFileAsBinaryString("proofOfIntention", "proof of intention image");

        // get addresses of all managers

        // encrypt proof of identity file for each manager
        
        // encrypt proof of intention file for each manager

        // upload the files to swarm

        var bzz = web3.bzz;

        // var dir = {
        //     "/foo.txt": {type: "text/plain", data: "sample file"},
        //     "/bar.txt": {type: "text/plain", data: "another file"}
        // };
        var supportingEvidenceSwarmHash = await bzz.upload(dir);

        // execute the createAccount transaction with the URI of the supporting evidence
        
        await app.contract.proposeCreateAccount(selectedAccount, supportingEvidenceSwarmHash, {from: selectedAccount});

        app.setStatus("Transaction complete!");

    } 
    catch(error) 
    {
        app.setStatus(error);
    }

}

function populateProofOfIntentionText() {
    var dropDown = document.getElementById("ethereumAddress");
    var selectedAccount = dropDown.options[dropDown.selectedIndex].value;
    var text = "I want a VillageCoin account for " + selectedAccount.substring(0, 8);
    document.getElementById("proofOfIntentionText").innerHTML = text;
}

function populateAccountsDropDown() {
    web3.eth.getAccounts(function(err, accs) {
        if (err != null) {
            return;
        }

        var html = accs
            .map(function(account){ return "<option value='" + account + "'>" + account + "</option>";})
            .reduce(function(accumulator, currentValue) { return accumulator + currentValue; }, "");
        document.getElementById("ethereumAddress").innerHTML = html;

        populateProofOfIntentionText();
    });    
}

window.addEventListener('load', function() { 
    populateAccountsDropDown();    
});

</script>
